# 데드락 처리

InnoDB 스토리지 엔진은 내부적으로 잠금 대기 목록을 그래프(Wait-for List) 형태로 관리한다.

그리고 데드락 감지 스레드를 가지고 있어서 주기적으로 이 그래프를 이 스레드로 검사해 데드락에 빠진 트랜잭션을 찾아 제거하는 데,  
검사하는 도중 그래프가 업데이트 되면 데드락 문제를 감지하는데 문제가 생길 수 있기 때문에 검사를 시작할 때 그래프에 lock을 건다.

만약 데드락 감지 스레드가 느려지면 서비스 쿼리를 처리 중인 스레드는 더 작업을 진행하지 못하고 대기해야 한다.  
그리고 동시 처리 스레드가 매우 많으면 데드락 감지 스레드는 더 많은 CPU 자원을 소모할 수 있다.

이런 문제점을 해결하기 위해 MySQL 서버는 innodb_deadlock_detect 시스템 변수를 제공해 데드락 감지 스레드의 동작 여부를 제어할 수 있게 한다.  
그런데 이를 OFF로 만들면 데드락이 발생해도 해결할 수가 없게 된다. innodb_deadlock_detect 를 OFF하고 데드락 문제가 해결되도록 하려면 innodb_lock_wait_timeout 를 활성화해야 한다.  
innodb_lock_wait_timeout 시스템 변수를 활성화하면 설정한 시간 동안 잠금을 획득하는데 실패했을 때 쿼리가 실패하고 에러를 반환한다.