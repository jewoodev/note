# 스프링 부트의 프로덕션 준비 기능

스프링 부트는 개발자가 시스템을 운영하면서 필요한 지표 시각화 기능을 제공한다. 또, 다양한 모니터링 시스템과 연동할 수 있게 하는 기능도 제공한다.

## Actuator가 제공하는 엔드포인트

스프링은 Actuator로 여러 엔드포인트를 제공해 운영을 하는데 확인할 필요가 있는 여러 지표들을 확인할 수 있게 한다.

### health

DB 연결 상태, 디스크 여유량, 활성화 여부 등을 보여준다.

### loggers

이 엔드포인트에서는 로그를 만들어내는 곳들에서, 로그 정보가 갖는 위험도를 어떤 것부터 볼 것인지에 대한 설정 정보를 보여준다. 그리고 실시간으로 로그 설정을 변경할 수 있게 해준다.

기본적으로 모든 로그를 기록하게 되면 불필요한 세부 정보들을 출력하기 위해 성능이나 디스크가 영향을 받게되기 때문에 `INFO` 레벨이 DEFAULT 설정인데, 급박한 상황에는 로그 설정을 다시 하고 싶게 된다.  
방법은 이 엔드포인트로 변경하고자 하는 설정값을 JSON 형태로 POST 요청해주면 된다.

## 마이크로미터

세상에는 많은 모니터링 툴이 존재하고 기술을 계속해서 변화하기 때문에 교체를 해야하는 순간들이 찾아올 것이다. 그리고 각각의 툴은 다른 방식으로 지표값들을 다루기 때문에 서버의 지표값들을 모니터링 툴에 제공하는 코드도 달라져야 한다. 

그럴 때마다 드는 개발 비용을 생각하면 비효율적인 부분이 있기 마련이다. 스프링은 이런 부분을 추상화를 통해 해결한다. `마이크로미터`라는 인터페이스로 모니터링 툴에 대한 기능들이 표준을 제공하고 각 도구들에 맞는 구현체마저 제공한다.

그리고 마이크로미터로 보여주는 지표들을 메트릭이라 이름붙여 부른다. 

> ex) 톰캣에서 사용 가능한 쓰레드 갯수, 메모리 최대량과 사용량 ..등등 

## 프로메테우스와 그라파나

메트릭을 영속하여 서버가 다운되는 경우에도 메트릭을 보호해야 한다. 그를 위해 메트릭을 저장할 DB가 필요하다. 그런 역할을 프로메테우스가 담당한다.

그리고 프로메테우스에서 데이터를 가져와서 사용자 친화적으로 시각화해주는 대시보드가 그라파나이다.

### 프로메테우스 기능

프로메테우스는 레이블이라는 명칭으로 부르는 구분 정보로 메트릭의 정보를 구분한다(마이크로미터는 이것을 태그(tag)라고 함). 

테이블 란에서 `Evaluation time`을 수정해서 데이터를 확인할 기간을 설정할 수 있고 `Graph`를 눌러 메트릭을 그래프 형태로 조회할 수 있다.

프로메테우스의 메트릭은 크게 `게이지`와 `카운터`로 나눌 수 있는데  
게이지는 상승과 하강이 있는 측정값들,  
카운터는 단순하게 쌓여서 증가하는 누적값을 의미한다.

그 중에서 카운터는 단순히 쌓이는 양상을 시각화하여서는 데이터 변화 양상을 보기 힘들기 때문에 `increase()`나 `rate()` 함수를 사용함으로써 단순히 증가하는 누적값의 변화 양상을 살펴보는 것을 권장한다.

이런 기능을 제공하는 프로메테우스는 한 눈에 들어오는 대시보드를 만들기 어렵다는 단점이 있다. 이 단점은 그라파나로 해결할 수 있다.

### 그라파나 
 
그라파나를 실행하고 프로메테우스를 데이터소스로 등록하여 대시보드를 만들고 원하는 패널을 등록해 운영에 필요한 정보들을 확인할 수 있다.  

CPU 사용량 매트릭으로 패널을 만들려면 PromQL에 날릴 지시자를 알아야 하겠다.

- 시스템의 CPU 사용량: `system_cpu_usage`
- JVM 프로세스 CPU 사용량: `process_cpu_usage`

디스크 사용량 매트릭으로 패널을 만드려면 PromQL에 날릴 지시자를 알아야 하겠다.

- 디스크의 전체 용량: `disk_total_bytes`
- 디스크의 여유 용량: `disk_free_bytes`

사용 중인 용량을 매트릭으로 설정하려면 `disk_total_bytes - disk_free_bytes`로 쿼리하면 된다.



# 참고 자료
- [김영한님의 스프링 부트- 핵심 원리와 활용](https://www.inflearn.com/course/%EC%8A%A4%ED%94%84%EB%A7%81%EB%B6%80%ED%8A%B8-%ED%95%B5%EC%8B%AC%EC%9B%90%EB%A6%AC-%ED%99%9C%EC%9A%A9/dashboard)