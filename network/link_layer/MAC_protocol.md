네트워크 계층에서 다음 홉의 라우터에게 프레임을 보낼 때 여러 라우터가 다음 홉의 대상이 될 수 있다. 그 홉들이 속하는 broadcast medium(브로드캐스트 매체)를 통해 모든 라우터에게 그 프레임이 전달된다. 이는 내가 친구 A에게만 이야기하지만 공기(broadcast medium)를 통해 같은 공간에 있는 B에게도 목소리가 들리는 것과 흡사하다. 

그렇게 다수의 라우터가 같은 브로드캐스트 매체를 공유하고 있기 때문에 동시에 프레임을 전송하는 일이 생기면 프레임 데이터가 섞이면서 수신 측에서 해독할 수 없게 된다. 이 현상을 collision 이라 부른다. 이때는 channel이 말 그대로 낭비된다.

여기서 중요한 건 collision 이 일어나지 않게 공유 자원을 사용할 수 있게 해야 한다는 것이다. 그걸 하는게 link layer 이다. 여기에서 말하는 collision은 앞서 서술한 유선 상의 프레임이 겹치는 것, 와이파이로의 프레임이 겹치는 것 등이 있다.

Link layer가 collision 이 일어나지 않게 medium 에 signal 을 올려놓는 걸 조절하는 기술을 **Medium Access Control**, MAC이라 부른다. 

# An ideal multiple access protocol
- **주어진 조건**: R bps 속도의 브로드캐스트 채널
- **원하는 조건**:
  1. 하나의 노드가 전송하고자 할 때, R 속도로 전송할 수 있어야 함
  2. M개의 노드가 전송하고자 할 때, 각각은 평균 R/M 속도로 전송할 수 있어야 함
  3. 완전히 분산화되어야 함:
    - 전송을 조정하는 특별한 노드가 없어야 함
    - 클록이나 슬롯의 동기화가 없어야 함
  4. 단순해야 함


# MAC protocols: taxonomy
- 세 가지 주요 클래스:
  - 채널 분할
    - 채널을 더 작은 "조각들"(시간 슬롯, 주파수, 코드)로 나눔
    - 노드에게 독점적 사용을 위한 조각을 할당
  - 랜덤 접근
    - 채널을 나누지 않고, 충돌을 허용
    - 충돌로부터 "복구"
  - 순서 교대
    - 노드들이 순서를 교대하되, 더 많이 보낼 것이 있는 노드는 더 긴 턴을 가질 수 있음


## Channel partitioning MAC protocols: TDMA
TDMA: 시분할 다중 접근
- "라운드" 단위로 채널에 접근
- 각 스테이션은 각 라운드에서 고정 길이 슬롯을 할당받음 (길이 = 패킷 전송 시간)
- **사용되지 않는 슬롯은 유휴 상태가 됨**
  - 예시: 6개 스테이션 LAN에서 1,3,4번이 패킷을 가지고 있고, 2,5,6번 슬롯은 유휴 상태 
    ![tdma_example.png](https://github.com/jewoodev/blog_img/blob/main/network/link_layer/MAC_protocol/TDMA_example.png?raw=true)


## Channel partitioning MAC protocols: FDMA
FDMA: 주파수 분할 다중 접근
- 채널 스펙트럼을 주파수 대역으로 나눔
- 각 스테이션에 고정 주파수 대역 할당
- 주파수 대역에서 사용되지 않는 전송 시간은 유휴 상태가 됨
  - 예시: 6개 스테이션 LAN에서 1,3,4번이 패킷을 가지고 있고, 2,5,6번 주파수 대역은 유휴 상태
    ![fdma_example.png](https://github.com/jewoodev/blog_img/blob/main/network/link_layer/MAC_protocol/FDMA_example.png?raw=true)


## Random access protocols
- 노드가 보낼 패킷을 가지고 있을 때
  - 전체 채널 데이터 속도 R로 전송
  - 노드들 간에 사전 조정 없음
- 둘 이상의 노드가 전송할 때 -> "충돌"
- 랜덤 접근 MAC 프로토콜은 다음을 규정함
  - 충돌을 감지하는 방법
  - 충돌로부터 복구하는 방법 (예: 지연된 재전송을 통해)
- 랜덤 접근 MAC 프로토콜의 예
  - 슬롯형 ALOHA
  - ALOHA
  - CSMA, CSMA/CD, CSMA/CA

### CSMA(carrier sense multiple access)
CSMA: listen before transmit    
전송 전에 수신 채널이 유휴 상태로 감지되면: 전체 프레임 전송
- 채널이 사용 중으로 감지되면, 전송을 연기
- 인간에의 비유: 다른 사람을 방해하지 마라!

### CSMA collisions
- 충돌은 여전히 발생할 수 있음: 전파 지연으로 인해 두 노드가 서로의 전송을 듣지 못할 수 있음
- 충돌: 전체 패킷 전송 시간이 낭비됨
  - 거리와 전파 지연이 충돌 확률을 결정하는 역할을 함

### Ethernet CSMA/CD algorithm
1. NIC가 네트워크 계층으로부터 데이터그램을 받아 프레임을 생성
2. NIC가 채널이 유휴 상태임을 감지하면, 프레임 전송을 시작. NIC가 채널이 사용 중임을 감지하면, 채널이 유휴 상태가 될 때까지 기다린 후 전송.
3. NIC가 다른 전송을 감지하지 않고 전체 프레임을 전송하면, NIC는 프레임 작업 완료!
4. NIC가 전송 중에 다른 전송을 감지하면, 중단하고 잼 신호 전송
5. 중단 후, NIC는 이진(지수) 백오프에 진입
  - m번째 충돌 후, NIC는 {0,1,2..., $2^{m}$ - 1}에서 K를 무작위로 선택. NIC는 K * 512 비트 시간만큼 대기한 후, 2단계로 돌아감
  - 충돌이 많을수록 더 긴 백오프 간격


## "Taking turns(순서교대)" MAC protocols
- 폴링:
  - 마스터 노드가 슬레이브 노드들을 순서대로 전송하도록 "초대"
  - 일반적으로 "무능한" 슬레이브 디바이스와 함께 사용됨
  - 우려사항:
    - 폴링 오버헤드
    - 지연시간
    - 단일 실패점(마스터)
- 토큰 전달:
  - 제어 토큰이 한 노드에서 다음 노드로 순차적으로 전달됨
  - 토큰 메시지
  - 우려사항:
    - 토큰 오버헤드
    - 지연시간
    - 단일 실패점(토큰)

## Summary of MAC protocols
- 시간, 주파수 또는 코드에 의한 채널 분할
  - 시분할, 주파수 분할
- 랜덤 접근 (동적)
  - ALOHA, S-ALOHA, CSMA, CSMA/CD
  - 반송파 감지: 일부 기술에서는 쉬움(유선), 다른 기술에서는 어려움(무선)
  - CSMA/CD는 이더넷에서 사용
  - CSMA/CA는 802.11에서 사용
- 순서 교대
  - 중앙 사이트에서의 폴링, 토큰 전달
  - 블루투스, FDDI, 토큰 링
