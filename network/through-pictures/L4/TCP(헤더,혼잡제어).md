# TCP 헤더
- 애플리케이션 계층에서 전송한 데이터는 트랜스포트 계층으로 전달됨
- 트랜스포트 계층에선 이 데이터에 '사용할 프로토콜의 헤더'를 붙임
  - TCP를 사용하면 TCP 헤더가 붙음
  - 헤더가 붙으면 세그먼트가 됨

## 헤더의 구성
1. 소스 포트(16bits), Destination port(16bits)
2. Sequence number(32bits)
   - 해당 데이터의 일련번호
     - 이를 이용해 데이터 순서가 뒤죽박죽으로 도착해도 원상태로 복구, 누락된 데이터 식별 가능
   - 처음 보낼 때 난수로 결정
     - 그 다음부턴 `'현재 시퀀스 넘버' + '데이터 크기' + 1`
3. Acknowledgment number(32bits)
    - 자신이 다음에 받아야 할 상대의 시퀀스 넘버
4. DO, Data Offset(4bits)
   - 현재 TCP 데이터가 'TCP Segment의 가장 앞'에서부터 얼마나 떨어져 있는지 나타냄
   - 즉, TCP 헤더의 크기를 나타냄
   - 기본값 5(`0101`)
5. RSV, Reserved(3bits)
   - 앞으로 필요할 때를 대비해 남겨놓은 필드
   - 사용되지 않고 있음
   - 원래는 더 컸었지만 컨트롤 플래그에 여러 필드가 등장해서 3bits까지 작아짐
6. Control flag(9bits)
   - 여러 필드로 구성됨
   - 각 필드는 사용 용도에 따라 다르게 설정됨
   1. NS, Nonce Sum
      - 악의적인 데이터인걸 은폐하는 것을 방지하기 위함
      - 아직 실험단계에 있음
   2. CWR, Congestion Window Reduced
      - 혼잡 제어를 할 때 쓰임
   3. ECE, ECN-Echo
      - 혼잡 제어를 할 때 쓰임
   4. URG, Urgent Pointer Present
      - 긴급하게 처리되야 하는 데이터를 나타내기 위함
      - 잘 사용되진 않음
   5. ACK, Acknowledgment Requested
      - 응답할 때 사용됨
      - 1인 경우 데이터를 잘 받았다는 의미
   6. PSH, Push Function Enabled
      - 1이면 상위 애플리케이션으로 최대한 빨리 전달하라는 의미
      - 0이면 버퍼링하는 것을 허용한다는 의미
   7. RST, Reset the Connection
      - 1이면 이미 연결된 커넥션을 강제로 끊는다는 걸 의미
   8. SYN, Synchronize Sequence Numbers
      - 커넥션을 생성할 때 사용됨
   9. FIN, Finish Sending
      - 1이면 연결을 끊고 싶다는 의미
5. Window size(16bits)
   - TCP의 흐름제어인 슬라이딩 윈도우를 사용할 때 사용됨
6. Checksum(16bits)
   - 데이터의 변조나 에러를 알아내기 위한 용도
7. Urgent pointer(16bits)
   - 컨트롤 플래그의 URG가 1인 경우 사용됨
     - 상위 애플리케이션에서 이 포인터가 가리키고 있는 데이터를 우선처리할 수도
     - 하지 않을 수도 있음
     - 결정하는 건 애플리케이션 개발자
8. Options
   - TCP 기능을 확장할 때 사용됨
   - 크기가 정해져있지 않고 가변적임
   - 최대 크기는 40bytes

---

# 흐름 제어와 혼잡 제어
## 흐름 제어
- 수신 측이 송신 측의 ACK를 받고 나서 데이터를 보낼 수 있는 방식은
- 신뢰성을 보장하지만
- 세그멘테이션으로 데이터를 분할해 전송하는 전략이니 만큼
- 여러번의 전송이 수행되는 과정에서 계속 ACK를 기다리며 성능이 나빠짐
- 이 문제를 해결하기 위해 한 번에 여러 개의 데이터를 보내기로 함
- 즉, 데이터의 흐름을 제어하는 것


- 전송할 데이터들이 있을 때 '윈도우'를 만들어 한 번에 보낼 영역을 지정
  - 한 번에 보낼 데이터의 크기를 '윈도우 사이즈'라고 함
- ACK가 올 때마다 ack 필드를 확인해서 윈도우를 N칸 이동
  - 칸: 세그멘테이션 데이터 하나의 크기
- 윈도우에 있는 '보내지 않은 데이터'를 한 번에 전송


- 똑같은 ack 번호로 ACK 메세지를 **세 번** 수신하면
  - 해당 데이터가 전송 실패했다고 간주하고 재전송함


- 윈도우 크기가 커질 수록 
  - 한 번에 많은 데이터를 보내기 때문에 통신 속도가 더 빨라질 수 있음
- 하지만
  - '수신 측의 네트워크'가 혼잡할 때 송신 측에서 데이터를 너무 많이 보내면
  - 문제가 생김
  - 그 상태를 '네트워크 혼잡' 상태라고 함

## 혼잡 제어
1. 송신 측에서 "처음 데이터를 보낼 때 윈도우 크기를 최대한 작게" 설정해
   - 한 번에 하나의 데이터만 보냄
   - 이를 **슬로우 스타트**라고 부름
2. 수신 측에서 데이터를 잘 받았다면 윈도우 크기를 2배 늘려서 
   - 더 많은 데이터를 전송함
3. 수신 측에서 너무 많은 데이터를 받았다고 전달하면
   - 다시 윈도우 크기를 절반으로 줄임
