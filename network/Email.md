일반 우편과 마찬가지로 전자메일은 비동기적인 통신 매체다. 현대의 전자메일은 첨부된 메세지, 하이퍼링크 HTML 포맷 텍슽, 내장된 사진 등 많은 강력한 특성을 갖고 있다.

인터넷 메일 시스템의 상위 레벨 개념에는 사용자 에이전트(user agent), 메일 서버, SMTP(Simple Mail Transfer Protocol)라는 3개의 주요 요소가 있음을 알 수 있다. 사용자 에이전트는 사용자가 메세지를 읽고, 응답하고, 전달하고, 저장하고, 구성하게 해준다. 유저 A가 메세지 작성을 끝내면, 사용자 에이전트는 메세지를 메일 서버로 보내고, 거기서 메세지는 메일 서버의 출력 메세지 큐에 들어간다. 밥이 메세지를 읽고 싶을 때 그의 사용자 에이전트는 메일 서버에 있는 메일박스에서 메세지를 가져온다.

메일 서버는 전자메일 인프라스트럭처의 중심이다. 수신자는 메일 서버 안에 **메일박스**를 갖고 있다. 유저 A의 메일박스는 유저 A에게 온 메세지를 유지하고 관리한다. 일반 메세지는 송신자의 사용자 에이전트에서 전달이 시작되고, 송신자의 메일 서버를 거친 후에 수신자의 메일 서버로 전달된다. 거기서 수신자의 메일박스에 저장된다. 유저 A가 메일박스에 있는 메세지를 보려할 때, 메일 서버는 사용자 계정과 비밀번호를 이용한 인증을 요구한다. 유저 A의 메일 서버는 유저 B의 메일 서버의 고장에도 대처해야 한다. 유저 A의 서버가 메일을 유저 B의 서버로 전달할 수 없다면, 유저 A의 서버는 그 메세지를 메세지 큐에 보관하고 나중에 재차 그 메세지를 전달하려 시도한다. 재시도는 약 30분마다 일어난다. 여러 날동안에 실패하게 되면, 서버는 그 메세지를 제거하고 송신자(유저 A)에게 전자메일로 이를 통보한다.

SMTP는 인터넷 전자메일을 위한 주요 애플리케이션 계층 프로토콜이다. SMTP는 메일을 송신자의 메일 서버로부터 수신자의 메일 서버로 전송하는 데 TCP의 신뢰적인 데이터 전송 서비스를 이용한다. 대부분의 애플리케이션 계층 프로토콜처럼, SMTP는 송신자 메일 서버에서 수행하는 클라이언트와 수신자 메일 서버에서 수행되는 서버를 갖고 있다. SMTP의 클라이언트, 서버의 역할은 모든 메일 서버에서 수행된다. 메일 서버가 상대 메일 서버로 메일을 보낼 땐 SMTP의 클라이언트로 동작하는 반면, 메일 서버가 상대 메일 서버로부터 메일을 받을 때는 SMTP 서버로 동작한다.

## 1. SMTP

SMTP는 HTTP보다 훨씬 오래됐다. SMTP는 여러 장점을 갖고 있지만, 낡은 특성을 가진 오래된 기술이다. 예를 들어, 모든 메일 메세지의 몸체(헤더뿐 아니라)는 단순한 7비트 ASCII여야 한다. 이 제한은 전송용량이 제한되고 커다란 첨부파일이나 커다란 이미지, 오디오 혹은 비디오 파일을 보내지 않았던 1980년대 초에는 나름 의미가 있었다. 그러나 오늘 날의 멀티미디어 시대에서 7비트 ASCII 제한은 문제를 일으킨다. SMTP를 통해 이진 멀티미디어 데이터를 보내기 전에 ASCII로 변환하는게 필요하다. 그리고 SMTP 전송 후엔 ASCII를 다시 원래 메세지로 변환해야만 한다. 그런데 HTTP는 전송 전에 멀티미디어 데이터를 ASCII로 변환하는 것을 요구하지 않는다.

SMTP는 다음과 같이 동작한다.

1. 유저 A는 전자메일 사용자 에이전트를 통해 유저 B의 전자메일 주소를 제공하고 메세지를 작성하고 사용자 에이전트에게 메세지를 보내라고 명령한다.
2. 유저 A의 사용자 에이전트는 메세지를 유저 A의 메일 서버에 보내고 그곳에서 메세지는 메세지 큐에 놓인다.
3. 유저 A의 메일서버에서 동작하는 SMTP 클라이언트 측은 메세지 큐에 있는 메세지를 본다. 그리고 유저 B의 메일 서버에서 수행되고 있는 SMTP 서버에 TCP 연결을 설정한다.
4. 초기 SMTP 핸드셰이킹 이후에 SMTP 클라이언트는 유저 A의 메세지를 TCP 연결로 보낸다.
5. 유저 B의 메일 호스트에서 SMTP 서버 측은 메세지를 수신한다. 유저 B의 메일 서버는 그 메세지를 유저 B의 메일 박스에 놓는다.
6. 유저 B는 편한 시간에 그 메세지를 읽기 위해 사용자 에이전트를 실행한다.

SMTP는 메일을 보낼 때 두 메일 서버가 먼 거리에 떨어져 있더라도 중간 메일 서버를 사용하지 않는다는 걸 이해하는 것이 중요하다. 유저 A의 메일 서버가 홍콩에 있고 유저 B의 서버가 세인트루이스에 있다면, TCP 연결은 홍콩과 세인트루이스 서버 사이의 직접 연결이다. 만약 유저 B의 메일 서버가 죽어 있다면 메세지는 어느 중간 메일 서버에 저장되는 것이 아니라 유저 A의 메일 서버에 남아 새로운 시도를 위해 기다린다.

이제 SMTP가 메세제를 송신 메일 서버에서 수신 메일 서버로 어떻게 전송하는지 살펴보자. 

1. SMTP 클라이언트는 SMTP 서버의 25번 포트로 TCP 연결을 설정한다. 만약 서버가 죽어있으면 나중에 다시 시도한다.
2. TCP 연결이 설정되면, 서버와 클라이언트는 애플리케이션 계층 핸드셰이킹을 수행한다. 이 SMTP 핸드셰이킹 과정 동안 SMTP 클라이언트는 송신자의 전자메일 주소와 수신자의 전자메일 주소를 제공한다. 
3. SMTP 클라이언트와 서버가 서로 소개를 마치면, 클라이언트는 서버에 메세지를 보낸다. SMTP는 서버에 오류 없이 메세지를 전달하기 위해 TCP의 신뢰적인 데이터 전송 서비스를 의존한다. 
4. 클라이언트가 서버에 보낼 메세지가 추가적으로 더 있다면, 클라이언트는 이 과정을 같은 TCP 연결을 통해 반복한다. 그렇지 않으면 TCP에게 연결을 닫을 것을 명령한다.

