컨슈머 랙은 우리가 컨슈머 애플리케이션을 운영할 때, 나아가서는 전체 데이터 파이프라인을 운영할 때 가장 중요한 지표 중 하나이다. 이걸 모니터링 하지 않는다면 우리는 데이터 처리가 정상적으로 되지 않고 있는 것이나 다름없다고 할 수 있을 정도이다.

![consumer-lag1.png](../../../blog-img/kafka/consumer-application/consumer-lag/consumer-lag1.png)

컨슈머 랙(LAG)은 파티션의 **최신 오프셋**(LOG-END-OFFSET)과 **컨슈머 오프셋**(CURRENT-OFFSET)간의 **차이**다. 따라서 컨슈머 랙이 커진다면 지연이 커지고 있다는 게 되며, 반대로 랙이 작아진다면 지연이 적어지고 있다는 게 된다. 이러한 컨슈머 랙을 통해 컨슈머가 정상 동작하는지 여부를 확인할 수 있는 것이기 때문에 컨슈머 애플리케이션을 운영한다면 필수적으로 모니터링해야 되는 것이다.

![consumer-lag2.png](../../../blog-img/kafka/consumer-application/consumer-lag/consumer-lag2.png)

컨슈머 랙은 컨슈머 **그룹**, **토픽**, **파티션** 별로 생성된다. 그리고 하나의 컨슈머 그룹마다 별도의 컨슈머 랙이 생성된다. 그래서 1개의 토픽에 3개의 파티션이 있고 2개의 컨슈머 그룹이 토픽을 구독한다면 총 6개의 컨슈머 랙이 생성된다.

## 프로듀서와 컨슈머의 데이터 처리량의 차이
![consumer-lag3.png](../../../blog-img/kafka/consumer-application/consumer-lag/consumer-lag3.png)

프로듀서가 **보내는 데이터 양**이 컨슈머의 **데이터 처리량**보다 커지면 컨슈머 랙이 늘어난다. 이러한 관점에서 컨슈머 랙의 늘어남은 컨슈머가 정상적으로 데이터를 처리하지 못하고 있다는 것을 알려준다.

## 컨슈머 랙 모니터링의 중요성
컨슈머 랙을 모니터링하는 건 카프카 데이터 파이프라인을 운영하는데에 **핵심적인 역할**을 한다.  
컨슈머 랙을 모니터링함으로써 컨슈머의 장애를 확인할 수 있으며 파티션 개수를 정할 때 참고할 수도 있기 때문이다.

예를 들어, 내비게이션의 사용자 데이터를 전송하는 프로듀서가 있다고 가정해보자. 추석, 설날처럼 내비게이션 사용량이 많을 때 프로듀서가 카프카 클러스터로 전송하는 데이터양은 평소보다 훨씬 커진다. 이때 컨슈머의 최대 처리량이 '컨슈머가 평소에 전송하는 데이터양'에 맞춰 한정되어 있다면 컨슈머 랙이 발생할 수 있다. 

이런 경우에는 컨슈머 랙을 줄이기 위해 일시적으로 파티션 개수와 컨슈머 개수를 늘려 병렬처리량을 늘리는 방법을 사용할 수 있다.

## 컨슈머 랙 모니터링 - 파티션 이슈
![consumer-partition-issue.png](../../../blog-img/kafka/consumer-application/consumer-lag/consumer-partition-issue.png)

프로듀서의 데이터양이 일정하더라도 컨슈머의 장애로 컨슈머 랙이 증가할 수도 있다. 그럼 일단 컨슈머의 개수를 파티션 개수만큼 늘려서 각 파티션의 처리 경과를 지켜본 후 컨슈머 랙이 늘어나는 파티션을 확인하여 원인을 파악하자.

## 컨슈머 랙을 확인하는 방법 3가지 - 카프카 명령어 사용
kafka-consumer-groups.sh 명령어를 사용하면 컨슈머 랙을 포함한 특정 컨슈머 그룹의 상태를 확인할 수 있다. 이 방법은 컨슈머 랙을 확인할 수 있는 방법 중 가장 기초적인 것으로 다음과 같이 명령어를 사용하면 된다.
```shell
bin.kafka-consumer-groups.sh --bootstrap-server my-kafka:9092 --describe --group consumer-group-1
```

이 방법은 일회성에 그치는 면이 있어 지표를 지속적으로 기록하고 모니터링하기에는 부족하다. 그렇기 때문에 테스트용 카프카에 주로 사용한다.

### metrics() 메서드 사용
컨슈머 애플리케이션에서 KafkaConsumer 인스턴스의 metrics() 메서드를 활용하면 컨슈머 랙 지표를 확인할 수 있다. 컨슈머 인스턴스가 제공하는 컨슈머 랙 관련 모니터링 지표는 세 가지로 records-lag-max, records-lag, records-lag-avg 다.

```java
for (Map.Entry<MetricName, ? extends Metric> entry : KafkaConsumer.metrics().entrySet()) {
    if ("records-lag-max".equals(entry.getKey().name()) 
        || "records-lag".equals(entry.getKey().name()) 
        || "records-lag-avg".equals(entry.getKey().name())) {
        Metric metric = entry.getValue();
        logger.info("{}:{}", entry.getKey().name(), metric.metricValue());
    }
}
```

#### metrics() 메서드 사용 이슈
- 이 메서드는 컨슈머가 호출하는 대상이므로 컨슈머가 정상적으로 실행되고 있을 때만 호출 가능하다. 그래서 만약 컨슈머 애플리케이션이 비정상적으로 종료되면 컨슈머 랙을 모니터링할 수 없게 된다.
- 컨슈머 애플리케이션을 여러 종류로 운영할 경우 각기 다른 컨슈머 애플리케이션에 metrics() 메서드를 호출하여 컨슈머 랙을 수집하는 로직을 중복해서 넣어야 한다. 왜냐하면 특정 컨슈머 그룹에 해당하는 애플리케이션이 수집하는 컨슈머 랙은 자신 컨슈머 그룹에 대한 컨슈머 랙만 한정되기 때문이다. 
- 컨슈머 랙을 모니터링하는 코드를 추가할 수 없는 카프카 서드 파티 애플리케이션의 컨슈머 랙은 모니터링이 불가능하다.

### 외부 모니터링 툴 사용
컨슈머 랙을 모니터링하는 방법 중 가장 최선의 방법이다. 데이터 독(Datadog), 컨플루언트 컨트롤 센터(Confluent Control Center)와 같은 카프카 클러스터 종합 모니터링 툴을 사용하면 카프카 운영에 필요한 다양한 지표를 모니터링할 수 있다. 이런 도구들의 모니터링 지표에는 컨슈머 랙도 포함되어 있어서 클러스터 모니터링과 컨슈머 랙을 함께 모니터링할 수 있다. 컨슈머 랙 모니터링만을 위한 툴로 오픈소스 버로우(Burrow)도 있다.



