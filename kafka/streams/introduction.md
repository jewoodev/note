카프카 스트림즈는 토픽에 적재된 데이터를 실시간으로 변환해서 다른 토픽에 적재하는 역할을 수행하는 라이브러리이다. **카프카에서 공식적으로 지원**하는 것으로 카프카의 새로운 버전이 나올 때마다 스트림즈 자바 라이브러리도 함께 릴리즈된다. 즉, 자바 기반 스트림즈 애플리케이션은 카프카 클러스터와 완벽하게 호환되면서 스트림 처리에 필요한 편리 기능들을 제공한다.

스트림즈 애플리케이션 또는 카프카 브로커에서 장애가 발생하더라도 **정확히 한 번**(exactly once)할 수 있도록 **장애 허용 시스템**(fault tolerant system)을 가지고 있어 데이터 처리 안정성이 매우 뛰어나다.  
카프카 클러스터를 운영하면서 실시간 스트림 처리를 해야할 필요가 있다면 카프카 스트림즈 애플리케이션 개발을 1순위로 고려하는 것이 좋다.

### 프로듀서와 컨슈머를 조합하지 않고 스트림즈를 사용해야 하는 이유
**스트림 데이터 처리**에 필요한 기능들이 스트림즈DSL로 제공되며, 프로세서 API를 이용한 기능 확장도 가능하기 때문이다.  

컨슈머와 프로듀서를 조합해 스트림즈가 제공하는 기능과 유사하게 만들 수도 있다. 하지만 스트림즈 라이브러리를 통해 제공하는 **단 한 번의** 데이터 **처리**, **장애 허용 시스템** 등은 컨슈머 & 프로듀서 조합으로는 완벽한 구현이 어렵다.

스트림즈가 제공하지 못하는 기능들도 있으므로 그런 기능을 구현할 땐 컨슈머와 프로듀서 조합을 사용하면 좋다.  
예를 들어, 소스 토픽과 싱크 토픽(저장하는 토픽)의 카프카 클러스터가 서로 다른 경우는 스트림즈로 구현할 수 없어 컨슈머 & 프로듀서 조합으로 직접 클러스터를 지정하는 개발 방식을 사용할 필요가 있다.

## 스트림즈 내부 구조
![streams-inner-structure.png](https://github.com/jewoodev/blog-img/blob/main/kafka/streams/streams-inner-structure.png?raw=true)

스트림즈 애플리케이션은 내부적으로 스레드를 1개 이상 생성할 수 있으며, 스레드는 1개 이상의 태스크를 가진다.  
'**태스크**'는 스트림즈 애플리케이션을 실행하면 생기는 데이터 처리 **최소 단위** 이다. 만약 3개의 파티션으로 이루어진 토픽을 처리하는 스트림즈 애플리케이션을 실행하면 내부에 3개의 태스크가 생긴다. 컨슈머의 병렬 처리를 위해 컨슈머 그룹으로 이루어진 컨슈머 스레드를 여러 개 실행하는 것과 비슷하다고 할 수 있다.  

카프카 스트림즈는 컨슈머 스레드를 늘리는 방법과 동일하게 파티션과 스트림즈 스레드(또는 프로세스) 개수를 늘려 병렬 처리로 처리량을 늘릴 수 있다.

## 스트림즈 애플리케이션 스케일 아웃
![streams-scale-out.png](https://github.com/jewoodev/blog-img/blob/main/kafka/streams/streams-scale-out.png?raw=true)

실제 운영환경에서는 장애가 발생하더라도 안정적으로 운영할 수 있도록 2개 이상의 서버로 구성하여 스트림즈 애플리케이션을 운영한다. 이를 통해 일부 '스트림즈 애플리케이션' 또는 '애플리케이션이 실행되는 서버'에 장애가 발생하더라도 안전하게 스트림 처리를 할 수 있다.

## 토폴로지
![topology.png](https://github.com/jewoodev/blog-img/blob/main/kafka/streams/topology.png?raw=true)

카프카 스트림즈의 구조와 사용 방법을 알기 전에 스트림즈가 사용하는 토폴로지가 무엇인지 알아보자. 스트림즈는 트리 형태와 유사한 토폴로지를 사용한다.

## 프로세서와 스트림
![processor-and-stream.png](https://github.com/jewoodev/blog-img/blob/main/kafka/streams/processor-and-stream.png?raw=true)

카프카 스트림즈에서 토폴로지의 노드를 하나의 '**프로세서**'라고 부르고 노드와 노드 사이를 이은 선을 '**스트림**'이라고 부른다. 스트림은 토픽의 데이터를 뜻하는 데 프로듀서와 컨슈머에서의 레코드와 동일한 개념이다.

### 소스 프로세서, 스트림 프로세서, 싱크 프로세서
프로세서의 종류 세 가지이다. 소스 프로세스는 데이터를 처리하기 위해 **최초**로 선언해야 하는 노드로 하나 이상의 토픽에서 데이터를 **가져오는 역할**을 한다. 스트림 프로세서는 다른 프로세서가 반환한 데이터를 **처리하는 역할**을 한다. 마지막으로 싱크 프로세서는 데이터를 특정 카프카 토픽에 **저장하는 역할**을 하며 스트림즈로 처리된 데이터의 최종 종착지이다.

## 스트림즈DSL과 프로세서API
카프카 스트림즈는 스트림즈DSL(Domain Specific Language)과 프로세서API 2가지 방법으로 개발할 수 있다. 전자는 스트림 프로세싱엥 쓰일 만한 다양한 기능들을 자체 API로 만들어 놓았기 때문에 대부분의 변환 로직을 어렵지 않게 개발할 수 있다. 스트림즈DSL이 제공하지 않는 기능들은 프로세서API를 사용해 구현할 수 있다. 각각의 방법으로 구현 가능한 종류는 다음과 같다.

- **스트림즈DSL**
  - 메세지 값을 기반으로 토픽 분기 처리
  - 지난 10분간 들어온 데이터의 개수 집계
- **프로세서API**
  - 메세지 값의 종류에 따라 토픽을 가변적으로 전송
  - 일정한 시간 간격으로 데이터 처리

