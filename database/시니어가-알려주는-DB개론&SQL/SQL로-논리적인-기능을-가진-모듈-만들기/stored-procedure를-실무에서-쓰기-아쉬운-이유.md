# 3-tier architecture에서 stored procedure의 의미
logic tier에 위치하는 비즈니스 로직이 data tier에도 있게됨을 의미한다.

## stored procedure를 사용해서 얻는 장점
- application에 transparent하다.
  - 비즈니스 로직을 수정할 때 logic tier에서 수정이 이루어지면, 배포를 해줘야 한다. 트래픽 처리가 가능해야 하므로 서버 인스턴스를 나누어 몇 개는 내렸다가 띄워주고 그동안에 몇 개는 유지해야 한다. 
    - 비즈니스 로직을 바꿔줄 때마다 컴파일 새로 하고 빌드해서 배포파일 만든 뒤에 서버 인스턴스 하나씩 새로운 인스턴스로 재시작해주는 것은 번거롭다.
  - 비즈니스 로직이 procedure로 관리가 되면 procedure 바디 부분만 수정하면 끝난다.
  - transparent 하다는 표현은, 뭔가를 바꿔도 바꾸기 전에 사용하고 있었던 부분들을 바꾸지 않고도 그 내용을 바꿀 수 있다는 의미이다.
- network traffic을 줄여서 응답 속도를 향상시킬 수 있다.
  - 로직을 수행하는 동안 발생되는 서버와 DB 간의 네트워크 통신이 없어지기 때문이다.
- 여러 서비스에서 재사용이 가능하다.
  - Spring, Django, nodejs 등의 스택으로 카카오 유저 서비스, 카카오페이 서비스처럼 여러 개의 서비스가 하나의 DB를 조회할 수 있다.
    - logic tier에 구현해야 한다면 같은 로직을 각기 다른 기반으로 로직을 구현해야 한다.
    - DB의 stored procedure로 구현한다면 각각의 서버에서 프로시저를 호출하기만 하면 된다.
- 민감한 정보에 대한 접근을 제한할 수 있다.
  - 개인정보와 같이 민감한 정보를 가지고 있는 DB에 직접적인 접근은 막은 채로, 그런 민감한 정보를 다루는 프로시저에만 접근을 허용할 수 있다.

## stored procedure의 단점과 실무에서 쓰기 어려운 이유
- stored procedure를 쓰면 유지보수 관리 비용이 커진다.
  - 비즈니스 로직에서 일부는 소스 코드 상으로 관리되고 일부는 프로시저로 관리되면, 유지보수할 때 소스 코드와 프로시저 내용을 번갈아가며 확인해야해서 제대로 로직을 파악하는데 시간이 오래걸리고 버전 관리 포인트가 두 개가 된다. 
  - 소스 코드 버전 관리는 오늘날 지원이 잘 되지만 프로시저의 버전, 코드 관리는 빈약하기 때문에 불편함이 생긴다.
  - 프로시저 문법에 대해서 개발자들이 공부해야하는 비용이 생긴다.
  - 새로운 기능을 만들 때 새로운 프로시저를 만들게 되면, 결국 그 프로시저를 호출하는 코드를 소스 코드에 추가해야 하므로 WAS도 새로 배포하고 재시작을 해야 한다.
- DB 서버를 추가하는 것은 간단한 작업이 아니다.
  - 여러 대의 서버 인스턴스와 하나의 DB 서버가 있다면, DB의 CPU 사용량이 가장 높을 것이다.
  - 이런 상황에서 트래픽이 갑자기 폭팔적으로 늘면 DB 서버의 CPU 사용량이 거의 100%를 찍을 수 있다.
  - 그럼 느려지고 버벅거리며 몇몇 기능은 안되기도 할 것이다.
  - 이를 해결하기 위해 새로운 DB 서버를 붙여도 그건 텅 비어있는 DB이기 때문에 그것에 부하를 분산시킬 수 없다.
    - 데이터를 새로운 DB에 복사하는 것은 굉장히 무겁고 오랜 시간이 드는 작업이다.
- stored procedure가 언제나 transparent한 것은 아니다.
- transparent하다고 무조건 좋은 것이 아니다.
  - 프로시저의 바디를 수정했을 때 버그가 발생하면, 버그가 발생했던 요청들을 보낸 유저들이 피해를 본다.
  - logic tier에서 인스턴스 하나에만 새로운 코드를 반영해서 문제가 없는지 보면 보다 적은 유저들이 피해를 본다. (예상치 못한 문제의 영향을 최소화)
- 재사용 가능하다는 것이 양날의 검이 될 수 있다.
  - 여러 개의 서비스가 통제되지 않은 채로 프로시저를 사용하게 되면 프로시저를 사용하는 모든 서비스에 문제가 발생할 수 있다.
  - 이 문제를 막기 위해 DB 앞에 Data Service를 두고 모든 서비스가 프로시저 대신 Data Service가 제공하는 RESTful API를 호출하게 한다.
    - 특정 서비스가 너무 많이 API를 호출하면 그 서비스의 사용을 block할 수 있다.
  - 결국 이것은 프로시저 호출 부를 logic tier의 단일 인스턴스에서 관리하는 방법으로 data tier로의 의존성을 줄이는 방법이다.
- 비즈니스 로직을 소스 코드에 두고도 응답 속도를 향상시킬 수 있다.
  - 스레드 풀을 사용하거나 non blocking I/O를 사용해서 여러 개의 SQL 명령 요청을 거의 동시에 보낼 수 있다. 
  - 순차적으로 다른 데이터를 조회해야 하는 로직의 응답 속도를 캐시를 사용해서 향상시킬 수 있다.
    - 응답 속도도 향상시키고, DB 부하도 줄일 수 있다.
- stored procedure가 민감한 정보에 대한 접근을 완벽히 제한할 순 없다.
  - 만약 개발자가 안좋은 마음을 갖고 민감한 정보를 반환하는 프로시저를 작성할 수도 있다.
  - DB로의 직접적인 접근을 막고 프로시저를 통해서만 정보를 얻을 수 있다면 개발과 CS 업무의 속도가 느려진다.
  - 따라서 
    - 담당자나 개발자에게만 DB 혹은 테이블 권한을 부여하고
    - 민감한 정보는 암호화해서 저장하고
    - 보안서약서 등을 통해 정책적으로 보안을 강화하자.

- 이외에도
  - procedure로는 복잡하고 유연한 코드를 작성하기 어렵다.
  - 오늘날의 프로그래밍 언어는 훨씬 다양하고 강력한 기능들을 제공한다.
  - procedure는 가독성이 떨어진다.
  - procedure는 디버깅이 어렵다.