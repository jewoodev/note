# 리팩토링이란?
리팩토링은 '프로그램의 겉으로 드러나는 동작은 그대로 유지하면서 이해하기 쉽게, 유지 보수하기 쉽게 내부 구조를 개선하는 작업' 을 말한다. 간단하게 표현하면 '기능은 그대로 두고 설계만 개선하는 작업' 이다. 

리팩토링은 내부 구조를 변경하기 때문에 버그가 발생할 확률이 높다. 따라서 리팩토링에는 안전장치가 필요하다. 그런 안전장치가 테스트이다.  

리팩토링은 동작을 그대로 유지하는게 핵심이다. 리팩토링 후 동작이 변경되었다는 건 버그가 발생했다는 것을 의미한다. 그래서 리팩토링을 하면서 중간중간 동작이 바뀌지 않았는지 확인하는 게 굉장히 중요한데, 테스트를 활용하면 그러한 확인 작업이 굉장히 쉬워진다. 

리팩토링할 코드의 동작을 검증하는 테스트가 있으면, 리팩토링을 한 다음에 그 테스트를 실행시켜서 문제가 없는지 검증해 볼 수 있다. 따라서 테스트를 통해 배포 후에 장애가 발생하는 것을 방지할 수 있다. 

정상적으로 동작하던 기능에서 문제가 생긴 경우를 Regression 버그, 또는 회기 버그라고 한다. 정상적으로 동작하던 기능에 문제가 없는지 검증하는 테스트를 Regression 테스트, 또는 회귀 테스트라고 한다. 안전하게 리팩토링을 하기 위해서 회귀 테스트는 필수다.

코드를 리팩토링 하기 전에 성공했던 테스트들이 리팩토링이 끝난 후에도 계속 성공하도록 만드는 게 리팩토링의 핵심이다. 

## 리팩토링을 잘하는 방법
마틴 파울러는 "리팩터링을 하기 위해서는 먼저 기능에 대한 테스트를 만들어야 한다." 고 강조했다. 그리고 "테스트를 자주 실행하라." 고도 했다. 테스트를 자주 실행할수록 마지막 실행 후에 수정한 코드 양이 적어져서 테스트가 실패하는 원인을 파악하는 게 쉽고 빨라진다. 

안전하게 리팩토링하려면 리팩토링 하기 전에 테스트를 작성하고 테스트를 자주 실행하는 습관을 들이는 것이 중요하다. 

테스트하기 쉽게 코드를 작성하라. 리팩토링 관점에서 보면 "얼마나 쉽게 테스트를 실행할 수 있는지" 가 "코드를 얼마나 쉽게 리팩토링할 수 있는지" 를 결정하기 때문에 테스트가 쉽도록 설계하는 것이 매우 중요할 수 밖에 없다.

### 테스트하기 쉽게 설계하는 방법
일단 테스트가 가능하게 하려면 테스트 관점에서 객체를 바라보는 것이 중요하다.   
잘 설계된 객체는 **자신의 상태는 내부로 감추고**, 외부에서는 **인터페이스를 통해서만 접근을 허용**한다.   
이 객체와 협력하고 싶은 객체는 메세지를 전송해서 도움을 요청한다. 외부에 있는 객체는 내부의 상태를 변경하기 위해 직접 접근할 수 없고, 대신 메세지를 전송해서 상태를 변경해달라고 요청해야 한다.   
메세지를 수신한 객체는 내부 상태를 스스로 수정한다. 외부 객체가 객체에 대한 정보를 필요로 하면, 메세지의 반환값으로 정보를 제공해야 한다. 내부 상태에 직접 접근하는 걸 허용해서는 안 된다.

테스트도 다른 객체처럼 메세지를 전송해서 객체의 상태를 변경하고 변경된 상태를 조회할 수 있다. 많은 테스트가 동작을 요청하고 상태를 반환받아서 객체의 동작을 검증하는데, 그렇게 객체의 상태를 이용해서 객체를 검증하는 방식을 **상태 기반 검증** 이라고 부른다. 

객체 간에 주고 받는 메세지는 크게 두 가지로 나눌 수 있다. 하나는 "다른 객체로부터 정보를 받기 위해" 전송하는 메세지로, 객체의 입력이 된다. 나머지 하나는 "다른 객체의 상태를 바꾸기 위해" 전송하는 메세지로, 객체의 출력이 된다. 다른 객체에게 전송되는 메세지를 출력으로 불 수 있기 때문에, 출력 메세지가 정상적으로 전달되었는지 확인하는 방식으로 테스트가 작성되기도 한다. 이렇게 다른 객체와의 협력을 기반으로 객체의 동작을 검증하는 방식을 **상호작용 기반 검증**이라고 한다.

테스트의 관점에서 객체를 정리해보면 이렇다. 테스트의 입력은 객체의 상태, 객체에게 전송하는 메세지의 파라미터, 다른 객체에게 전송하여 얻은 메세지의 반환값으로 구성된다. 테스트의 출력은 변경된 상태를 조회하는 메세지의 반환값과 다른 객체의 상태를 변경하기 위해 요청하는 메세지의 전송 여부로 구성된다. 이렇게 보면 객체를 테스트한다는 이야기는 입력을 이용해서 "어떤 객체에게 어떤 동작을 수행할지" 를 지시하고, 출력을 통해서 "객체가 어떻게 실행되었는지" 를 확인하는 과정이라고 할 수 있다.  
따라서, 테스트에서 가장 중요한 건 객체의 입력과 출력을 얼마나 쉽게 제어할 수 있느냐이다. 입력을 제어하기 어려우면 객체를 원하는 대로 동작하게 만들기가 어렵고, 출력을 제어할 수 없으면 테스트 결과를 검증하기rk 어렵다. 입력과 출력을 제어하기 힘들 때의 더 큰 문제는 테스트의 작성이 불가능하거나, 이해하기 어렵게 테스트를 작성해야 한다는 점이다. 

# 기타 추가 메모

테스트들 끼리 상태를 공유하면, 테스트 사이에 의존성이 생겨 정상적인 테스트가 실패할 수 있다. 

테스트는 리팩토링 과정에서 발생한 오류를 감지해주는 동시에, 설계의 품질을 개선하기 위해 리팩토링해야 하는 코드를 알려주는 역할도 수행한다. 

클래스를 얼마나 쉽게 테스트할 수 있느냐가 설계의 품질을 측정하는 중요한 척도이다. 테스트를 작성하기 어려운 클래스는 설계도 좋지 않다. 테스트하기 어려운 코드를 만났다면 "코드를 개선하라." 는 시그널로 받아들여도 좋다. 이런 신호를 감지했을 때 적용할 수 있는 중요한 설계 원칙들을 살펴보려 한다.

설계 원칙은 코드에 어떤 문제가 있는지 평가할 수 있는 기준을 제공하는 동시에 어떤 구조를 목표로 리팩토링하면 되는지를 알려주는 설계 가이드 역할을 한다.