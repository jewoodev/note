# 다형성 패턴과 변경 보호 패턴

할인 정책의 종류로 "금액 할인 정책"과 "비율 할인 정책"과 같이 할인이 적용되는 정책의 종류가 다수가 있는 문맥에서 할인 적용 로직은 응집도가 낮아질 수 있다.

각 정책에 맞는 상황인지 판별하고 그 정책에 맞는 금액 계산을 해야하기 위해 아래와 같은 방식으로 설계를 한다면 말이다.

```java
class Item {
    private DiscountPolicy discountPolicy;
    
    public Money calculatePrice(/* ... */) {
        if (/* 금액 할인 조건인지 판별 */) {
            return discountPolicy.calculateAmountDiscount();
        } else if (/* 비율 할인 조건인지 판별 */) {
            return discountPolicy.calculatePercentDiscount();
        }
    }
}

class DiscountPolicy {
    /* 비율 할인 정책을 위한 데이터 */
    /* 금액 할인 정책을 위한 데이터 */
    
    public Money calculatePercentDiscount() {
        // ...
    }
    
    public Money calculateAmountDiscount() {
        // ...
    }
}
```

## 문제점 파악

현재 DiscountPolicy는 서로 상관없는 데이터와 로직이 한 곳에 섞여 응집도가 낮다. 여기에 새로운 할인 정책을 추가해야 하면 DiscountPolicy에 메소드를 추가하는 방법을 선택하게 될 것이다.  
그럼 정책을 추가할 때마다 DiscountPolicy를 수정해야 한다는 것을 알 수 있다. 그리고 추가될 수록 DiscountPolicy는 응집도가 낮은 데이터와 로직으로 뚱뚱해져 처참한 가독성을 자랑하게 될 것이다.

또 새로운 정책과 아무런 상관이 없는 코드들이 영향을 받게 되는 문제도 확인할 수 있다. 어떤 사이드 이펙트가 생겨날지 예측하기 어려워질 때도 있을 것이다. 

그리고 Item 객체에도 새로운 할인 정책을 판별하는 새로운 조건문이 추가되어야 한다. 높은 결합도 문제도 있는 것이다. 지금의 설계는 변경에 의한 파급 효과를 제어하지 못하고 있다. 

## 해결 방법

비율 할인 정책과 금액 할인 정책, 이처럼 하나의 타입이라고 볼 수 있지만 서로 다르게 행동하는 개념(객체)들이 존재할 때 다형성 패턴을 적용할 수 있다. 

이 패턴은 "다형적인 메세지를 이용해서 행동이 변하는 타입들에게 각 행동을 다루기 위한 책임을 할당하라"는 해결방법을 제시한다.

"할인을 적용한 값을 계산한다." 라는 "이 케이스에는 금액 할인 정책을 적용해서..." 나 "저 케이스에는 금액 할인 정책을 적용해서..." 처럼 경우에 따라 다르게 해석될 수 있는 **다형적**인 메세지를 이용해 할인을 계산하는 행동이 달라지는 할인 정책 종류 각각을 독립적인 객체로 분리해 책임을 할당하라는 것이다.

### 다형적인 메세지를 구현하기

다형적인 메세지는 변경 보호 패턴을 사용해 구현할 수 있다. 이 패턴은 할인 정책의 종류처럼 변화하는 요소에 코드가 강하게 결합되어 수정하기 어려워지는 문제를 해결하기 위한 패턴이다.

이 패턴을 적용해서 결합도를 낮추기 위해 변하는 부분을 식별하고 그 부분 주변에 안정적인 인터페이스나 추상화를 도입하면 된다.